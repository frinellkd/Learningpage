{% extends 'base.html' %}
{% block body %}

<script>
// For handling wikipedia links
$(document).ready(function(){
  $("#wiki a[href^='/wiki']")
   .each(function()
   { 
      this.href = this.href.replace(/^.*\/wiki\//, 
         "http://wikipedia.org/wiki/")
   });

});
</script>

<script>

//Create the variables that will be used within the map configuration options.
//The latitude and longitude of the center of the map.
var topicMapCenter = new google.maps.LatLng({{map_data.center_lat}},{{map_data.center_lng}});
//The degree to which the map is zoomed in. This can range from 0 (least zoomed) to 21 and above (most zoomed).
var topicMapZoom = {{map_data.zoom}};
// The max and min zoom levels that are allowed.
var topicMapZoomMax = {{map_data.maxzoom}};
var topicMapZoomMin = {{map_data.minzoom}};

//These options configure the setup of the map. 
var topicMapOptions = { 
          center: topicMapCenter, 
          zoom: topicMapZoom,
          //The type of map. In addition to ROADMAP, the other 'premade' map styles are SATELLITE, TERRAIN and HYBRID. 
          mapTypeId: google.maps.MapTypeId.ROADMAP,
          maxZoom:topicMapZoomMax,
          minZoom:topicMapZoomMin,
          
};

//Create the variable for the topic map itself.
var topicMap;





//THE MAIN FUNCTION THAT IS CALLED WHEN THE WEB PAGE LOADS--------------------------------------------------------------------------------
function loadtopicMap() {
    
  //The empty map variable ('topicmap') was created above. The line below creates the map, assigning it to this variable. The line below also loads the map into the div with the id 'topic_map{{topic_id}}' (see code within the 'body' tags below), and applies the 'topicMapOptions' (above) to configure this map. 
  topicMap = new google.maps.Map(document.getElementById("topic_map{{topic_id}}"), topicMapOptions); 


  //Calls the function below to load up all the map markers.
  loadMapMarkers();

  };

var marker_dict = {};
//Function that loads the map markers.
function loadMapMarkers (){

 {% for data in event_data %}
        {% if data.image %}
        var infowindow{{data.event_data_id}} = new google.maps.InfoWindow({
            content: '({{data.event_title}}.) {{data.description}}<img src="{{data.image}}"  style="width:48px; height:48px;">'
            });

        {% else %}
        var infowindow{{data.event_data_id}} = new google.maps.InfoWindow({
            content: '{{data.event_title}}. {{data.description}}'
            });
        {% endif %}

        var myLatlng = new google.maps.LatLng({{data.lat}}, {{data.lng}});

        // attach markers to each topic locaiton retruned in JSON
            var marker{{data.event_data_id}} = new MarkerWithLabel({
                    map: topicMap,
                    title: '{{data.event_title}}',
                    labelContent: {{loop.index}},
                    labelAnchor: new google.maps.Point(6,35),
                    labelClass: "labels",
                    labelInBackground: false,
                    position: myLatlng,
                    
                    
            });        
            
            marker{{data.event_data_id}}.addListener('click', function(){
            infowindow{{data.event_data_id}}.open(topicMap, marker{{data.event_data_id}});    
            });

      marker_dict['{{data.event_data_id}}'] = marker{{data.event_data_id}}

{% endfor %} 
    };

//When the page loads, the line below calls the function below called 'loadTopicMap' to load up the map.


google.maps.event.addDomListener(window, 'load', loadtopicMap);

</script>

<!--Begin script for Timeline-->
<script>
var timeline;
var event_dict = {}    
google.setOnLoadCallback(drawTimeline);

function drawTimeline() {
  // Creates and populate a data table.
        
      var events = []
      var dt, d, t, date_list, year, month, day, hour, minute, start, end 
      var styear, stmonth, stday, etyear, etmonth, etday
      

    {% for data in event_data %}

      dt = '{{data.event_date}}';
      dt_list = dt.split(" ");
      d= dt_list[0];
      t= dt_list[1];

      date_list= d.split('-') ;
      time_list= t.split(':');

      year = date_list[0];
      month = date_list[1];
      day = date_list[2];
      hour = time_list[0];
      minute = time_list[1]

      
              
      events.push({
            {% if data.image %}
            'start': new Date(year, month, day, hour, minute),
            'content': '({{loop.index}}) {{data.event_title}}<br>'+'<img src="{{data.image}}"  style="width:48px; height:48px;">',
            'className': 't_event{{data.event_data_id}}'
            
            {% else %}
            'start': new Date(year, month, day, hour, minute),
            'content':'({{loop.index}}) {{data.event_title}}',
            'className': 't_event{{data.event_data_id}}'
            

            {% endif %}
            });

      event_dict['{{loop.index0}}'] = {{data.event_data_id}};
          
    {% endfor %}

      styear = {{time_data.start_date.year}};
      etyear= {{time_data.end_date.year}};
           
      stmonth = {{time_data.start_date.month}};
      etmonth = {{time_data.start_date.month}};
      
      stday = {{time_data.start_date.day}};
      etday = {{time_data.start_date.day}};
      
      var Start_t =  new Date(styear, stmonth);
      var End_t = new Date(etyear, etmonth);

      console.log(Start_t)
      console.log(End_t)

    // Instantiate our timeline object.
    timeline = new links.Timeline(document.getElementById('mytimeline'));

    // specify options

   
    timeline.setOptions({
      "width":  "100%",
      "height": "auto",// optional after this point
      "style": "box",
      "selectable": true,
      "cluster": true,
      "box.align": "center",
      "start": new Date(styear, stmonth, stday),
      "end": new Date(etyear, etmonth, etday),
      "stackEvents": true
     });

    // Draw our timeline with the created data and options
    timeline.draw(events);

    //Adds listener to the events created
    links.events.addListener(timeline, 'select', onselect);

}

function onselect(){
  var sel = timeline.getSelection();
  var event_index = (sel[0].row);
  console.log(event_index) 
  console.log(Object.prototype.toString.call(event_index));
  console.log(event_dict)
  var data_id = event_dict[event_index];
  console.log(data_id)
  var map_marker = marker_dict[data_id];
  console.log(map_marker)
  topicMap.setZoom(17);
  topicMap.panTo(map_marker.position); 
}


       
</script>
    <!--End script for timeline-->




<h1>{{wiki_title|safe}}</h1>


{% for key in youtube_keys %}

<div class="video_wrapper" id='thumbnails'>
        <!--Creates images that can be clicked to start corresponding video-->
        <img id='thumbnail_{{key.youtube_video_key}}' src='http://img.youtube.com/vi/{{key.youtube_video_key}}/hqdefault.jpg'/ >
</div >

<div id='vph'></div>



<script>
    // embeds a video upon clicking the image related to the video
var embedVid_{{key.youtube_video_key}} = '<iframe width="560" height="315" src="https://www.youtube.com/embed/{{key.youtube_video_key}}?rel=0&autoplay=1" frameborder="0" allowfullscreen></iframe>'

$('#thumbnail_{{key.youtube_video_key}}').on("click", function(evt) {
        evt.preventDefault();
        $("#vph").html(embedVid_{{key.youtube_video_key}});
});


</script>
{% endfor %}

 
<!--creating a dropdown box-->  
<form>
  <div class="checkbox">
    <label>
      {%for data in event_data %}
          
        <input  type="checkbox"
              name="event{{loop.index}}"
              id="{{data.event_data_id}}"
              value="{{loop.index}}"
              checked=true
              onclick= 'validateme(this, marker_dict["{{data.event_data_id}}"], ".t_event{{data.event_data_id}}")'>({{loop.index}}) {{data.event_title}}<br>
              
      
      {% endfor%}
    </label>
  </div>  
</form>

<script>
//"""Function for checking whether an event is checked and disabling the map marker if not"""
function validateme(target, marker, t_event) {

  
  if (target.checked){
    console.log(target.id + " is checked");
    marker.setMap(topicMap);
    $(t_event).show()
    // document.getElementsByClassName(t_event).style.display = 'block'

  } else {
    console.log(target.id + " is unchecked"); 
    marker.setMap(null);
    $(t_event).hide();
    // document.getElementsByClassName(t_event).style.display = 'none';      
  }
  
}



</script>  

 



<div id="topic_map{{topic_id}}" class="topic_map"></div>
<div id='mytimeline'></div>
<container>
    <h1 id='wiki_title'>{{wiki_title|safe}}</h1>
    <div id='wiki'>{{wiki_data|safe}}</div>
</container>    

    

{% endblock %}